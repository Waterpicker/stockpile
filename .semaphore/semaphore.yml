version: v1.0
name: Stockpile CI pipeline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Setup"
    task:
      env_vars:
        - name: GRADLE_USER_HOME
          value: "gradle_ci_cache"

        - name: GRADLE_OPTS
          value: "-Dorg.gradle.daemon=false"

      jobs:
        - name: Cache dependencies
          commands:
            - checkout
            - cache restore gradle-$SEMAPHORE_GIT_BRANCH-$(checksum build.gradle)-$(checksum gradle.properties),gradle-$SEMAPHORE_GIT_BRANCH,gradle-master
            - ./gradlew dependencies
            - cache store gradle-$SEMAPHORE_GIT_BRANCH-$(checksum build.gradle)-$(checksum gradle.properties) gradle_ci_cache

  - name: "Test"
    task:
      env_vars:
        - name: GRADLE_OPTS
          value: "-Dorg.gradle.daemon=false"

      jobs:
        - name: Lint and run tests
          commands:
            - checkout
            - ./gradlew checkScalafmtAll
            - ./gradlew check